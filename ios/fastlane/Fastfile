# frozen_string_literal: true

default_platform(:ios)

platform :ios do
  # ==========================================
  # Configuration
  # ==========================================
  
  APP_IDENTIFIER = "org.reactjs.native.leejay100.RNWeb3Wallet"
  WORKSPACE = "RNWeb3Wallet.xcworkspace"
  SCHEME = "RNWeb3Wallet"
  PROVISIONING_PROFILE = "org.reactjs.native.leejay100.RNWeb3Wallet AppStore"
  
  # ==========================================
  # Lanes
  # ==========================================

  desc "Install CocoaPods dependencies"
  lane :install_pods do
    cocoapods(
      podfile: "./Podfile",
      try_repo_update_on_error: true
    )
  end

  desc "Build the app"
  lane :build do
    install_pods
    
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          APP_IDENTIFIER => PROVISIONING_PROFILE
        }
      },
      output_directory: "./build",
      output_name: "ChillyWallet.ipa",
      clean: true
    )
  end

  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Increment build number
    increment_build_number(
      xcodeproj: "RNWeb3Wallet.xcodeproj"
    )
    
    # Install pods
    install_pods
    
    # Build the app
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          APP_IDENTIFIER => PROVISIONING_PROFILE
        }
      },
      output_directory: "./build",
      output_name: "ChillyWallet.ipa",
      clean: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "ChillyWallet Beta - Bitcoin Cold Storage Wallet"
    )
    
    # Notify success
    puts "üöÄ Successfully uploaded to TestFlight!"
  end

  desc "Push a new release to the App Store"
  lane :release do
    # Increment version number
    increment_version_number(
      xcodeproj: "RNWeb3Wallet.xcodeproj"
    )
    
    # Build and upload
    build
    
    # Upload to App Store
    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: false,
      automatic_release: false,
      force: true
    )
  end

  desc "Upload metadata only (no binary)"
  lane :upload_metadata do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      metadata_path: "./fastlane/metadata"
    )
  end

  desc "Upload screenshots only"
  lane :upload_screenshots do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      force: true,
      screenshots_path: "./fastlane/screenshots"
    )
  end

  desc "Upload metadata and screenshots (no binary)"
  lane :upload_appstore_assets do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots"
    )
  end

  desc "Submit for App Store review"
  lane :submit_review do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true
      }
    )
  end

  desc "Sync code signing certificates and profiles"
  lane :sync_certificates do
    sigh(
      app_identifier: APP_IDENTIFIER,
      readonly: false
    )
  end

  desc "Register new devices"
  lane :register_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]
    
    register_devices(
      devices: {
        device_name => device_udid
      }
    )
  end

  # ==========================================
  # Error Handling
  # ==========================================
  
  error do |lane, exception|
    puts "‚ùå Error in lane #{lane}: #{exception.message}"
  end
end
