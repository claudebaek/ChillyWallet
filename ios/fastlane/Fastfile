# frozen_string_literal: true

default_platform(:ios)

platform :ios do
  # ==========================================
  # Configuration
  # ==========================================
  
  APP_IDENTIFIER = "com.chillywallet.app"
  WORKSPACE = "RNWeb3Wallet.xcworkspace"
  SCHEME = "RNWeb3Wallet"
  
  # ==========================================
  # Lanes
  # ==========================================

  desc "Install CocoaPods dependencies"
  lane :install_pods do
    cocoapods(
      podfile: "./Podfile",
      try_repo_update_on_error: true
    )
  end

  desc "Build the app"
  lane :build do
    install_pods
    
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ChillyWallet.ipa",
      clean: true
    )
  end

  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Increment build number
    increment_build_number(
      xcodeproj: "RNWeb3Wallet.xcodeproj"
    )
    
    # Install pods
    install_pods
    
    # Build the app
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ChillyWallet.ipa",
      clean: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "ChillyWallet Beta - Bitcoin Cold Storage Wallet"
    )
    
    # Notify success
    puts "üöÄ Successfully uploaded to TestFlight!"
  end

  desc "Push a new release to the App Store"
  lane :release do
    # Increment version number
    increment_version_number(
      xcodeproj: "RNWeb3Wallet.xcodeproj"
    )
    
    # Build and upload
    build
    
    # Upload to App Store
    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Sync code signing certificates and profiles"
  lane :sync_certificates do
    match(
      type: "appstore",
      app_identifier: APP_IDENTIFIER,
      readonly: true
    )
  end

  desc "Register new devices"
  lane :register_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]
    
    register_devices(
      devices: {
        device_name => device_udid
      }
    )
    
    match(
      type: "development",
      force_for_new_devices: true
    )
  end

  # ==========================================
  # Error Handling
  # ==========================================
  
  error do |lane, exception|
    puts "‚ùå Error in lane #{lane}: #{exception.message}"
  end
end
